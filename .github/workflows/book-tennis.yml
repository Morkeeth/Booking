name: Book Tennis Court

on:
  schedule:
    # Runs every THURSDAY at 8:00 AM CET (7:00 AM UTC)
    # Thursday = 4 (0=Sunday, 1=Monday, 2=Tuesday, 3=Wednesday, 4=Thursday)
    - cron: '0 7 * * 4'  # Every Thursday at 7 AM UTC = 8 AM CET
  
  workflow_dispatch:  # Allows manual triggering from GitHub Actions tab

jobs:
  book-court:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm install
      
      - name: Generate config from secrets
        run: |
          cat > config.json << EOF
          {
            "account": {
              "email": "${{ secrets.TENNIS_EMAIL }}",
              "password": "${{ secrets.TENNIS_PASSWORD }}"
            },
            "locations": [
              "Édouard Pailleron",
              "Candie",
              "Poliveau"
            ],
            "date": "12/11/2025",
            "hours": [
              "20"
            ],
            "priceType": [
              "Tarif plein",
              "Tarif réduit"
            ],
            "courtType": [
              "Découvert",
              "Couvert"
            ],
            "players": ${{ secrets.TENNIS_PLAYERS }},
            "ntfy": {
              "enable": ${{ secrets.NTFY_ENABLE || 'false' }},
              "topic": "${{ secrets.NTFY_TOPIC || 'YOUR-OWN-TOPIC' }}"
            },
            "ai": {
              "space": "FatBoyEnglish/Text_Captcha_breaker"
            }
          }
          EOF
      
      - name: Run booking script
        run: npm start
        continue-on-error: true
      
      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-screenshots-${{ github.run_number }}
          path: img/*.png
          retention-days: 7
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: booking-logs-${{ github.run_number }}
          path: |
            *.log
            event.ics
          retention-days: 7
